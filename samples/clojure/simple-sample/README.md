# Introduction to Clojure Development

As of OpenCV 2.4.4, OpenCV supports desktop Java development using
nearly the same interface as for Android development. [Clojure][1] is
a contemporary LISP dialect hosted on the Java Virtual
Machine. Clojure offers an high level of interoperability with the
underlying JVM which allows to easily create OpenCV applications by
using its java interface.

This guide will help in creating your first Clojure (CLJ) application
using OpenCV.

For detailed instruction on installing OpenCV with desktop Java
support refer to the [corresponding tutorial][2].

If you are in hurry, here is a minimum quick start to install OpenCV
on Mac OS X:

```bash
cd ~/
mkdir opt
git clone https://github.com/Itseez/opencv.git
cd opencv
mkdir build
cd build
cmake -DBUILD_SHARED_LIBS=OFF ..
...
...
make -j8
# optional
# make install
```

## Install Leiningen

Once you installed OpenCV with desktop java support the only other
requirement is to install [Leiningeng][3] which allows you to manage
the entire life cycle of your CLJ projects.

The available [installation guide][4] is very easy to be followed:

1. [Download the script][5]
2. Place it on your `$PATH` (cf. `~/bin` is a good choice if it is on
   your `path`.)
3. Set the script to be executable. (i.e. `chmod 755 ~/bin/lein`).

If you work on Windows, follow [this instruction][6]

## Install the local-repo Leiningen plugin

The set of commands (tasks in Leiningen parlance) natively supported
by Leiningen can be very easily extended by various plugins. One of
them is the [lein-localrepo][7] plugin which allows to install jar
libs as artifact in the local maven repository of your machine
(typically in the `~/.m2/repository` directory of your username).

We're going to use this `lein` plugin to add the java interface jar
and the corresponding shared native lib generated by the above OpenCV
build as maven artifact in the local repository.

Generally speaking, if you want to use it on a project base only, a
`lein plugin` can be added directly to a CLJ project created by
`lein`.

Instead, when you want a plugin to be available to any CLJ project in
your username space, you can add it to the `profiles.clj` in the
`~/.lein/` directory.

The `lein-localrepo` plugin will be useful to me in other projects
too. So I decided to make it available to any CLJ project as follows:

```bash
mkdir ~/.lein
```

Now create a file named `profiles.clj` in the `~/.lein` directory and
copy into it the following content:

```clj
{:user {:plugins [[lein-localrepo "0.5.2"]]}}
```

Here we're saying that the version release `"0.5.2"` of the
`lein-localrepo` plugin will be available to the `:user` profile for
any CLJ project created by `lein`.

You do not need to do anything else to install the plugin because it
will be automatically downloaded from a remote repository the very
first time you issue any `lein` task.

## Install the java specific libs as local repository

If you followed the standard documentation for installing OpenCV on
your computer, you should find the following two libs under the
directory where you built OpenCV:

* the `build/bin/opencv-247.jar` java lib
* the `build/lib/libopencv_java247.dylib` (or `.so` in you have a
  GNU/Linux OS)

Now create a new directory to store the above two libs and start by
copying into it the `opencv-247.jar` file.

```bash
cd ~/opt
mkdir clj-opencv
cd clj-opencv
cp cp ~/opt/opencv/build/bin/opencv-247.jar .
```

The shared native lib needs first to be packaged as a jar file for
being able to be added as artifact into the local repository.

Moreover the native lib has to be copied in a directories layout which
mimics the names of your operating system and its architecture. I'm
using a Mac OS X with a X86 64 bit architecture. So my layout will be
the following:

```bash
mkdir -p native/macosx/x86_64
cp ~/opt/opencv/build/lib/libopencv_java247.dylib native/macosx/x86_64/
```

> NOTE 1: On a GNU/Linux
> 
> ```bash
> mkdir -p native/linux/x86_64
> cp ~/opt/opencv/build/lib/libopencv_java247.so native/linux/x86_64/
> ```

Next you need to package the native lib in a jar file.

```bash
jar -cMf opencv-native-247.jar native
```

Your directories layout should look like the following:

```bash
tree
.
├── native
│   └── macosx
│       └── x86_64
│           └── libopencv_java247.dylib
├── opencv-247.jar
└── opencv-native-247.jar

3 directories, 3 files
```

We are now ready to add the two jars as artifacts to the local maven
repository with the help of the `lein-localrepo` plugin.

```bash
lein localrepo install opencv-247.jar opencv/opencv 2.4.7
```

Here we're installing the `opencv-247.jar` lib as a version release
`2.4.7` for the `opencv/opencv` (groupId/artifcatId) in the local
maven repository.

Do the same thing with the native lib wrapped in the jar file.

```bash
lein localrepo install opencv-native-247.jar opencv/opencv-native 2.4.7
```

Note that the groupId of the two artifact is the same
(i.e. `opencv/artifactId`).

We are now ready to create a new CLJ based OpenCV project.

## Create a project

Create a new CLJ project by using the `lein new` task from the
terminal.

```bash
# cd in the directory where you work with your development projects (e.g. ~/devel)
lein new simple-sample
Generating a project called simple-sample based on the 'default' template.
To see other templates (app, lein plugin, etc), try `lein help new`.
```

The above task creates the following `simple-sample` directories layout:

```bash
tree simple-sample/
simple-sample/
├── LICENSE
├── README.md
├── doc
│   └── intro.md
├── project.clj
├── resources
├── src
│   └── simple_sample
│       └── core.clj
└── test
    └── simple_sample
        └── core_test.clj

6 directories, 6 files
```

We need do add the two `opencv` artifacts as dependencies of the newly
created project. Open the `project.clj` and modify its dependencies
section as follows:

```bash
(defproject simple-sample "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.5.1"]
                 [opencv/opencv "2.4.7"] ; added line
                 [opencv/opencv-native "2.4.7"]]) ;added line
```

> NOTE 2: note that the Clojure Programming Language is an artifact
> too. This is why Clojure is called an hosted language.

To verify that everything went right issue the `lein deps` task.

```bash
cd simple-sample
lein deps
```

The `deps` task reads all the `simple-sample` project's dependencies
and verifies if they are already been cached in the local maven
repository. If the task returns without messages you installation is
correct, otherwise go back and check that you did everything right.

## Dry test

Now `cd` in the `simple-sample` directory and issue the following
`lein` task:

```bash
cd simple-sample
lein repl
...
...
nREPL server started on port 50907 on host 127.0.0.1
REPL-y 0.3.0
Clojure 1.5.1
    Docs: (doc function-name-here)
          (find-doc "part-of-name-here")
  Source: (source function-name-here)
 Javadoc: (javadoc java-object-or-class-here)
    Exit: Control+D or (exit) or (quit)
 Results: Stored in vars *1, *2, *3, an exception in *e

user=>
```

The very first time you run a `lein` task it will take sometimes to
download all the required dependencies before activating the
interactive REPL (Read Eval Print Loop). You can immediately interact
with the REPL by issuing any CLJ expression to be evaluated.

```clj
user=> (+ 41 1)
42
user=> (println "Hello, Clojure!")
Hello, Clojure!
nil
user=> (defn foo [] (str "bar"))
#'user/foo
user=> (foo)
"bar"
user=>
user=> (exit)
Bye for now!
```

## Add OpenCV dependencies to the project

Now open the `project.clj` file with your preferred editor to see its
content.

```clj
(defproject simple-sample "0.1.0-SNAPSHOT"
  :description "FIXME: write description"
  :url "http://example.com/FIXME"
  :license {:name "Eclipse Public License"
            :url "http://www.eclipse.org/legal/epl-v10.html"}
  :dependencies [[org.clojure/clojure "1.5.1"]])
```

As you see the only current dependency of the `simple-sample` project
is the `"1.5.1"` release of the Clojure Programming Language itself.

To be able to use the OpenCV Java interface and the corresponding
dynamic lib created when you install OpenCV with desktop java support,
you need to add them to the `:dependencies` section of the project.

```clj
(defproject simple-sample "0.1.0-SNAPSHOT"
  ...
  :dependencies [[org.clojure/clojure "1.5.1"]
                 [local/opencv "2.4.7"] ; new line
                 [local/opencv-native "2.4.7"]]) ; new line
```

The dependencies section of the project is represented as a vector of
vector where each vector element is generally composed of two values:

* the groupID/artifactId of the lib: e.g. `local/opencv`
* the lib version release: e.g. `"2.4.7"

We used `local` as `groupId` of both libs because we need to install
them locally on your machine and are not going to be downloaded from
the net.

## Package the OpenCV libs

Even if we already added the above OpenCV dependencies to the project,

interoperate with OpenCV through CLJ we need
Each dependencies is represented as a CLJ vector (e.g. `[local/opencv "2.4.7"]`). The first element of the vector is



a `lein` project is a kind of key/value map. Each key is a
`keyword` (e.g. `:description`, `:url`, etc) and each value could be
any CLJ expression: a string (e.g. `"FIXME: write description"`, a map
`{:name "Eclipse Public License" :url
"http://www.eclipse.org/legal/epl-v10.html"}` and even a vector of
vector (e.g. `[[org.clojure/clojure "1.5.1"]]`.


To exit the REPL just First let's run The generated
`project.clj` is used to configure the project and its
dependencies. By default it only add the `clojure` dependency to the
project.


The most important asset in the `simple-directory` is the
`project.clj` file used to configure the project dependencies. If you `cd


## Usage

FIXME

## License

Copyright © 2013 FIXME

Distributed under the Eclipse Public License either version 1.0 or (at
your option) any later version.
